<h2>Feedback Analysis</h2>

<div class="toolbar">
  <label>Select questionnaire:
    <select [value]="selectedId()" (change)="select($any($event.target).value)">
      <option *ngFor="let q of questionnaires" [value]="q.id">{{ q.title }}</option>
    </select>
  </label>
</div>

<section *ngIf="selectedQ as q; else none">
  <p class="muted">{{ q.description }}</p>

  <div class="grid">
    <div class="card" *ngFor="let qq of q.questions">
      <h3>{{ qq.prompt }}</h3>

      <ng-container *ngIf="qq.type === 'likert'">
        <div class="stat-row">
          <span>Average</span>
          <strong>{{ (avgLikert(qq, responsesFor(q.id)) ?? 0) | number:'1.1-2' }} / {{ qq.scaleMax }}</strong>
        </div>

        <div class="bars">
          <div class="bar" *ngFor="let entry of (distribution(qq, responsesFor(q.id)) | keyvalue)">
            <span class="label">{{ entry.key }}</span>
            <div class="track">
              <div class="fill" [style.width.%]="(entry.value / (responsesFor(q.id).length || 1)) * 100"></div>
            </div>
            <span class="count">{{ entry.value }}</span>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="qq.type === 'mcq'">
        <div class="bars">
          <div class="bar" *ngFor="let entry of (distribution(qq, responsesFor(q.id)) | keyvalue)">
            <span class="label">{{ entry.key }}</span>
            <div class="track">
              <div class="fill" [style.width.%]="(entry.value / (responsesFor(q.id).length || 1)) * 100"></div>
            </div>
            <span class="count">{{ entry.value }}</span>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="qq.type === 'text'">
        <ul class="answers">
          <li *ngFor="let t of textAnswers(qq, responsesFor(q.id))">“{{ t }}”</li>
          <li *ngIf="!textAnswers(qq, responsesFor(q.id)).length" class="muted">No text responses yet.</li>
        </ul>
      </ng-container>
    </div>
  </div>
</section>

<ng-template #none>
  <p class="muted">No questionnaires yet. Create one in the Questionnaire tab.</p>
</ng-template>
